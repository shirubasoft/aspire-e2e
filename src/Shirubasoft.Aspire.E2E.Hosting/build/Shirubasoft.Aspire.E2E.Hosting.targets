<Project>
  <Target Name="_ResolveSharedResourceProjectReferences" BeforeTargets="ResolveProjectReferences"
          Condition="'@(SharedResourceReference)' != ''"
          Outputs="%(SharedResourceReference.Identity)">

    <Exec Command="aspire-e2e get-mode %(SharedResourceReference.Identity)"
          ConsoleToMSBuild="true"
          IgnoreExitCode="true"
          StandardOutputImportance="low">
      <Output TaskParameter="ConsoleOutput" PropertyName="_ResolvedMode" />
      <Output TaskParameter="ExitCode" PropertyName="_ResolvedModeExit" />
    </Exec>

    <Exec Command="aspire-e2e get-project-path %(SharedResourceReference.Identity)"
          ConsoleToMSBuild="true"
          IgnoreExitCode="true"
          StandardOutputImportance="low"
          Condition="'$(_ResolvedMode)' == 'Project'">
      <Output TaskParameter="ConsoleOutput" PropertyName="_ResolvedProjectPath" />
    </Exec>

    <ItemGroup Condition="'$(_ResolvedModeExit)' == '0'">
      <SharedResourceReference>
        <Mode>$(_ResolvedMode)</Mode>
        <ProjectPath Condition="'$(_ResolvedMode)' == 'Project'">$(_ResolvedProjectPath)</ProjectPath>
      </SharedResourceReference>
    </ItemGroup>

    <ItemGroup Condition="'$(_ResolvedMode)' == 'Project' AND '$(_ResolvedProjectPath)' != ''">
      <ProjectReference Include="$(_ResolvedProjectPath)" />
    </ItemGroup>
  </Target>

  <Target Name="_SerializeSharedResourceReferences" BeforeTargets="CoreCompile"
          DependsOnTargets="_ResolveSharedResourceProjectReferences"
          Condition="'@(SharedResourceReference)' != ''">
    <PropertyGroup>
      <_SharedResourceReferencesJsonPath>$(IntermediateOutputPath)SharedResourceReferences.g.json</_SharedResourceReferencesJsonPath>
    </PropertyGroup>

    <ItemGroup>
      <_SharedResourceReferenceLines Include="@(SharedResourceReference->'  { &quot;Id&quot;: &quot;%(Identity)&quot;, &quot;Name&quot;: &quot;%(Name)&quot;, &quot;Mode&quot;: &quot;%(Mode)&quot;, &quot;ProjectPath&quot;: &quot;%(ProjectPath)&quot;, &quot;ContainerImage&quot;: &quot;%(ContainerImage)&quot;, &quot;ContainerTag&quot;: &quot;%(ContainerTag)&quot;, &quot;BuildImageCommand&quot;: &quot;%(BuildImageCommand)&quot;, &quot;BuildImage&quot;: &quot;%(BuildImage)&quot; }')" />
    </ItemGroup>

    <WriteLinesToFile File="$(_SharedResourceReferencesJsonPath)"
                     Lines="[;@(_SharedResourceReferenceLines, ',');]"
                     Overwrite="true" />

    <ItemGroup>
      <AdditionalFiles Include="$(_SharedResourceReferencesJsonPath)" />
    </ItemGroup>
  </Target>
</Project>
